# Cron Dockerfile for miHoYo Bot
FROM python:3.12-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1
ENV TZ=Asia/Bangkok
ENV PYTHONPATH=/app

# Install system dependencies including cron
RUN apt-get update && apt-get install -y \
    cron \
    sqlite3 \
    procps \
    tzdata \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \
    && echo $TZ > /etc/timezone \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Set the working directory
WORKDIR /app

# Create necessary directories
RUN mkdir -p /app/data /app/logs /app/backups

# Copy requirements first for better caching
COPY requirements.txt /app/

# Install Python dependencies
RUN pip install --upgrade pip \
    && pip install -r requirements.txt \
    && pip cache purge

# Copy the application code
COPY . /app/

# Create entrypoint script - runs as root so cron works
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
CRON_SCHEDULE="${CHECKIN_CRON_SCHEDULE:-5 23 * * *}"\n\
\n\
echo "Creating cron job with schedule: $CRON_SCHEDULE (Bangkok time)"\n\
echo "$CRON_SCHEDULE cd /app && python main.py >> /app/logs/cron.log 2>&1" > /etc/cron.d/mihoyo-cron\n\
echo "" >> /etc/cron.d/mihoyo-cron\n\
\n\
chmod 0644 /etc/cron.d/mihoyo-cron\n\
crontab /etc/cron.d/mihoyo-cron\n\
\n\
echo "Starting cron service..."\n\
cron -f\n\
' > /app/entrypoint.sh \
    && chmod +x /app/entrypoint.sh

# Run as root so cron can start properly
CMD ["/bin/bash", "/app/entrypoint.sh"]
